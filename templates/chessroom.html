<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Waiting for players...</title>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
      integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
      crossorigin="anonymous"
    ></script>
    <!-- The above script is to import Socket.IO library to JS. Taken from https://flask-socketio.readthedocs.io/en/latest/getting_started.html -->
    <!-- <link rel="stylesheet" href="{{url_for('static', filename='style.css')}}" /> -->
    <!-- ill use the below style sheet later for icons -->
    <link rel="stylesheet" href="../static/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
  </head>

  <body>
    <div id="result"></div>

    <div id="waiting-room" class="flex-col space-around gap">
      <dialog id="failedToStartGame">
        <h2 id="failureMessageHeading"></h2>
        <p id="failureMessage"></p>
        <form method="dialog"><button>Ok</button></form>
      </dialog>
      <h3 class="room-code">Code : {{room_code}}</h3>
      <div class="players flex space-around">
        <h2 id="player-1"></h2>
        <h2>vs</h2>
        <h2 id="player-2"></h2>
      </div>
      <button id="startGame">Start Game</button>
    </div>

    <div id="messageAlert">nikes and crytin</div>

    <div class="chatWindow">
      <div class="chatBox">
        <h1>Code: {{room_code}}</h1>
        <div class="messages" id="messages"></div>
        <form onsubmit="sendChatMessage(); return false;" id="chatForm">
          <input
            type="input"
            rows="3"
            placeholder="Enter your message here"
            name="chatInput"
            id="chatInput"
          />
          <button
            type="submit"
            name="sendMessage"
            id="send-msg-btn"
          >
            Send
          </button>
        </form> 
      </div>
    </div>
    
    <form method="post" id="logout">
      <button value="logout" id="logoutButton">Log out</button>
    </form>
  </div>
  <div id="game" class="invisible">
    <div id="black-promotion" class="invisible">
      <img src="{{url_for('static',filename='b9.png')}}" alt="" class="promo-piece"  data-value="-9">
      <img src="{{url_for('static',filename='b5.png')}}" alt="" class="promo-piece" data-value="-5">
      <img src="{{url_for('static',filename='b3.png')}}" alt="" class="promo-piece" data-value="-3">
      <img src="{{url_for('static',filename='b2.png')}}" alt="" class="promo-piece" data-value="-2">
    </div>
    <div class="board"></div>
    <div id="white-promotion" class="invisible">
      <img src="{{url_for('static',filename='w9.png')}}" alt="" class="promo-piece" data-value="9">
      <img src="{{url_for('static',filename='w5.png')}}" alt="" class="promo-piece" data-value="5">
      <img src="{{url_for('static',filename='w3.png')}}" alt="" class="promo-piece" data-value="3">
      <img src="{{url_for('static',filename='w2.png')}}" alt="" class="promo-piece" data-value="2">
    </div>
    <script src="./js/script.js">
    </script>
    <script
      src="{{url_for('script_js')}}"
      referrerpolicy="origin"
      defer
    ></script>
    <script type="text/javascript">
      var socketio = io(); // Connects to the backend Flask server, and emits a connect event.
      const waitingRoom = document.getElementById("waiting-room");
      const messageAlert = document.getElementById("messageAlert");
      const messages = document.getElementById("messages");
      const startGameButton = document.getElementById("startGame");
      const failedToStartGameModal = document.getElementById("failedToStartGame");
      const failedToStartGameHeading = document.getElementById("failureMessageHeading");
      const failedToStartGameMessage = document.getElementById("failureMessage");
      const gameBoard = document.getElementsByClassName("board")[0];
      const player1 = document.getElementById("player-1");
      const player2 = document.getElementById("player-2");
      const chatInput = document.getElementById("chatInput");
      const game=document.getElementById("game");
      let currNumPlayers = 0;
      let color;

      socketio.on("playerAlerts", (data) => {
        messageAlert.textContent = data.name + " " + data.message;
        animateMessage(messageAlert);
        currNumPlayers = parseInt(data.playerCount);
        player1.textContent = data.player1.username;
        if (data.player2.username !== "")
          player2.textContent = data.player2.username;
        else player2.textContent = "...";
      });

      startGameButton.addEventListener("click", () => {
        if (currNumPlayers < 2) {
          failedToStartGameHeading.innerHTML = `Insufficient players`;
          failedToStartGameMessage.textContent=` To start the game, You need exactly 2 players. You currently have ${currNumPlayers}.`;
          failedToStartGameModal.showModal();
        } else sendMessage("game", "start");
      });

      socketio.on("start", (data) => {
        color = data.color;
        console.log(data.color);
        waitingRoom.classList.toggle("invisible");
        game.classList.toggle("invisible");
        document.title = "Game in progress...";
        createBoard();
      });

      function createMessage(name, message) {
        const content = `
        <div class="message">
          <span>
            <strong>${name}</strong>: ${message}
          </span>
          <span class="muted">
            ${new Date().toLocaleString()}
          </span>
        </div>
        `;
        messages.innerHTML += content;
        messages.scrollTop=messages.scrollHeight-messages.clientHeight;
      }

      socketio.on("chat", (data) => {
        createMessage(data.name, data.message);
      });

      function sendChatMessage() {
        if(chatInput.value){
          sendMessage("chat", chatInput.value);
          chatInput.value = "";
        }
      }

      function sendMessage(event, message) {
        if (message === "") return;
        socketio.emit(event, { data: message }); // EMIT AN EVENT FROM CLIENT WHICH WE CAN LISTEN TO ON OUR SERVER.
      }

      socketio.on("redirect", (destination) => {
        window.location.href = destination;
      });

      socketio.on("gameEnded", () => {
        gameBoard.innerHTML = ``;
        game.classList.toggle("invisible");
        waitingRoom.classList.toggle("invisible");
      });

      function animateMessage(div) {
        div.animate([{ transform: "translate(-100%,0)" }], {
          duration: 500,
          fill: "forwards",
        });
        setTimeout(() => {
          div.animate(
            { transform: "translate(0,0)" },
            { duration: 500, fill: "forwards" },
          );
        }, 2000);
      }
    </script>
    <!-- {% for msg in messages %} -->
    <script type="text/javascript">
      createMessage("{{msg.name}}", "{{msg.message}}");
    </script>
    <!-- {% endfor %}  -->
  </body>
</html>
